<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¸ã‚«ãƒ«ãƒãƒ¥ãƒ­ãƒªãƒãƒƒãƒ—ã€€æ•´ç†åˆ¸</title>
    <style>
        /* ===== å…¨ä½“ ===== */
        body {
            font-family: "Hiragino Sans", sans-serif;
            background-color: #fff8f0;
            text-align: center;
            padding: 2em;
            margin: 0;
            font-size: 20px;
        }

        /* ===== è¦‹å‡ºã— ===== */
        h1 {
            color: #d17b00;
            margin-bottom: 1.5em;
            font-size: 3em;
        }

        /* ===== æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆ ===== */
        #guideText {
            font-size: 1.4em;
            color: #555;
            margin-bottom: 1.8em;
        }

        /* ===== ãƒœã‚¿ãƒ³ ===== */
        button {
            background-color: #ffb347;
            border: none;
            border-radius: 10px;
            padding: 1.2em 1em;
            font-size: 2.4em;
            cursor: pointer;
            width: 90%;
            max-width: 500px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #ffa41b;
        }

        /* ===== æ•´ç†åˆ¸ç•ªå·ãƒœãƒƒã‚¯ã‚¹ ===== */
        .ticket-box {
            background-color: #ffffff;
            border: 3px solid #f4a300;
            border-radius: 20px;
            padding: 0.4em 0.8em;
            text-align: center;
            font-size: 50px;
            color: #5a3a00;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin: 1.5em auto;
            width: min(90%, 500px);
            font-weight: bold;
            min-width: 140px;
        }


        #waitMessage {
            font-size: 1.3em;
            color: #444;
            margin-bottom: 1.5em;
        }

        /* ===== å‘¼ã³å‡ºã—ä¸­ç•ªå·ãƒªã‚¹ãƒˆ ===== */
        .call-list {
            margin-top: 3em;
            background-color: #fff;
            padding: 1.5em;
            border-radius: 12px;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            max-width: none;
        }

        .call-list h3 {
            margin-top: 0;
            color: #d17b00;
            font-size: 3em;
        }

        /* ===== å‘¼ã³å‡ºã—ç•ªå· ===== */
        .call-number {
            display: inline-block;
            border: 3px solid #ffb347;
            border-radius: 10px;
            padding: 0.7em 1.2em;
            margin: 0.3em;
            font-size: 2em;
            font-weight: bold;
            color: #d17b00;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, get, push, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://churros-2a-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // HTMLè¦ç´ 
        const getTicketBtn = document.getElementById("getTicket");
        const yourTicketBox = document.getElementById("yourTicketBox");
        const callList = document.getElementById("callList");
        const guideText = document.getElementById("guideText");
        const waitMessage = document.getElementById("waitMessage");

        let myTicketKey = localStorage.getItem("myTicketKey");
        let myTicketNum = localStorage.getItem("myTicketNum");
        let lastNotified = null;

        // åˆæœŸUI
        if (myTicketNum) showMyTicket(myTicketNum);
        else showGuide();

        // ğŸ« æ•´ç†åˆ¸å–å¾—å‡¦ç†
        getTicketBtn.addEventListener("click", async () => {
            if (myTicketKey) {
                alert("ã™ã§ã«æ•´ç†åˆ¸ã‚’ãŠæŒã¡ã§ã™ï¼");
                return;
            }

            // éå»æœ€å¤§ç•ªå·ã‚’å–å¾—
            const lastNumRef = ref(db, "lastNumber");
            const lastNumSnap = await get(lastNumRef);
            const lastNum = lastNumSnap.exists() ? lastNumSnap.val() : 0;
            const nextNumber = lastNum + 1;

            // tickets ã«è¿½åŠ 
            const newTicketRef = push(ref(db, "tickets"));
            await set(newTicketRef, { number: nextNumber, status: "waiting" });

            // lastNumber æ›´æ–°
            await set(lastNumRef, nextNumber);

            myTicketKey = newTicketRef.key;
            myTicketNum = nextNumber;
            localStorage.setItem("myTicketKey", myTicketKey);
            localStorage.setItem("myTicketNum", myTicketNum);

            showMyTicket(nextNumber);
        });

        // ğŸ§© æ¡ˆå†…è¡¨ç¤ºï¼ˆæœªå–å¾—æ™‚ï¼‰
        function showGuide() {
            guideText.textContent = "æ•´ç†åˆ¸ã‚’å–å¾—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ•´ç†åˆ¸ã‚’å—ã‘å–ã£ã¦ã­";
            getTicketBtn.style.display = "inline-block";
            yourTicketBox.style.display = "none";
            waitMessage.style.display = "none";
        }

        // ğŸ§© è‡ªåˆ†ã®ç•ªå·ã‚’è¡¨ç¤º
        function showMyTicket(num) {
            guideText.textContent = "ã‚ãªãŸã®ç•ªå·ã¯";
            getTicketBtn.style.display = "none";
            yourTicketBox.style.display = "block";
            yourTicketBox.textContent = num;
            waitMessage.style.display = "block";

            const charWidth = 1.2;
            yourTicketBox.style.width = `${String(num).length * charWidth}em`;
        }

        // ğŸ” å‘¼ã³å‡ºã—ä¸­ç•ªå·ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
        const ticketsRef = ref(db, "tickets");
        onValue(ticketsRef, (snapshot) => {
            const data = snapshot.val() || {};
            const calling = Object.values(data)
                .filter(t => t.status === "calling")
                .map(t => t.number)
                .sort((a, b) => a - b);

            renderCallingList(calling);

            // è‡ªåˆ†ã®ç•ªå·ãŒå‘¼ã°ã‚ŒãŸã‚‰é€šçŸ¥
            if (myTicketNum && calling.includes(Number(myTicketNum))) {
                notifyUser(myTicketNum);
            }

            // æ•´ç†åˆ¸ãŒå‰Šé™¤ã•ã‚ŒãŸï¼ˆå®Œäº†ï¼‰
            if (myTicketKey && !data[myTicketKey]) {
                localStorage.clear();
                myTicketKey = null;
                myTicketNum = null;
                alert("å•†å“ã®å—ã‘æ¸¡ã—ãŒå®Œäº†ã—ã¾ã—ãŸï¼ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™â™¡");
                showGuide();
            }
        });

        // ğŸ“‹ å‘¼ã³å‡ºã—ä¸­ãƒªã‚¹ãƒˆæç”»
        function renderCallingList(numbers) {
            callList.innerHTML = "";
            if (numbers.length === 0) {
                callList.innerHTML = "<p>ç¾åœ¨å‘¼ã³å‡ºã—ä¸­ã®ç•ªå·ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
                return;
            }
            numbers.forEach(num => {
                const div = document.createElement("div");
                div.className = "call-number";
                div.textContent = num;
                callList.appendChild(div);
            });
        }

        // ğŸ”” é€šçŸ¥å‡¦ç†
        function notifyUser(num) {
            if (lastNotified === num) return;
            lastNotified = num;

            if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
            alert(`ã‚ãªãŸã®ç•ªå· ${num} ãŒå‘¼ã°ã‚Œã¾ã—ãŸï¼`);

            if (Notification.permission === "granted") {
                new Notification(`ç•ªå· ${num} ãŒå‘¼ã°ã‚Œã¾ã—ãŸï¼`);
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then((perm) => {
                    if (perm === "granted") new Notification(`ç•ªå· ${num} ãŒå‘¼ã°ã‚Œã¾ã—ãŸï¼`);
                });
            }
        }
    </script>
</head>

<body>
    <h1>ãƒã‚¸ã‚«ãƒ«ãƒãƒ¥ãƒ­ãƒªãƒãƒƒãƒ—<br>æ•´ç†åˆ¸</h1>

    <div id="guideText"></div>

    <div id="yourTicketBox" class="ticket-box" style="display:none;"></div>
    <div id="waitMessage" style="display:none;">ãŠå‘¼ã³å‡ºã—ã¾ã§ãŠå¾…ã¡ãã ã•ã„</div>

    <button id="getTicket">æ•´ç†åˆ¸ã‚’å–å¾—</button>

    <div class="call-list">
        <h3>ğŸ“£ ç¾åœ¨å‘¼ã³å‡ºã—ä¸­ã®ç•ªå·</h3>
        <div id="callList"></div>
    </div>
</body>

</html>