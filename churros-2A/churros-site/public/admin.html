<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>マジチュロ 管理ページ</title>
  <style>
    body {
      font-family: "Hiragino Sans", sans-serif;
      text-align: center;
      background: #fff8f0;
      color: #333;
      padding: 30px;
    }

    h1 {
      color: #d17b00;
      margin-bottom: 20px;
    }

    .lists-container {
      display: flex;
      justify-content: space-between;
      /* 左右に広げる */
      gap: 0.5em;
      /* ボックス間の隙間 */
      margin-top: 20px;
    }

    .list-box {
      flex: 1;
      /* 横幅いっぱいに均等割り */
      max-width: 49%;
      /* 少し余白を残す */
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      min-width: 120px;
    }

    /* ✅ 呼び出し済みボックスを横2列分の幅に */
    .completed-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .completed-box {
      width: calc(100% - 0.5em);
      /* 上2つの隙間分を差し引く */
      max-width: 100%;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }


    .ticket {
      display: inline-block;
      background-color: #ffffff;
      border: 3px solid #f4a300;
      border-radius: 6px;
      padding: 10px 20px;
      margin: 5px;
      font-size: 1.5em;
      font-weight: bold;
      cursor: pointer;
    }

    .ticket:hover {
      background-color: #ffd180;
    }

    button {
      background: #ffb347;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-size: 1em;
    }

    button:hover {
      background-color: #ffa41b;
    }

    /* スマホでも横並び維持 */
    @media (max-width: 500px) {
      .lists-container {
        flex-direction: row;
      }

      .list-box {
        max-width: 48%;
        padding: 18px;
      }


      .ticket {
        font-size: 1.4em;
        padding: 1em 1.5em;
        margin: 0.5em 0.3em;
      }

      button {
        font-size: 1.2em;
        padding: 1em 2em;
      }

      .completed-box {
        width: 100%;
        padding: 18px;
      }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://churros-2a-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ticketsRef = ref(db, "tickets");
    const callingList = document.getElementById("callingList");
    const waitingList = document.getElementById("waitingList");
    const clearAllBtn = document.getElementById("clearAll");
    const completedList = document.getElementById("completedList");

    // リアルタイムでチケット情報を取得
    onValue(ticketsRef, (snapshot) => {
      const data = snapshot.val() || {};
      const waiting = [];
      const calling = [];
      for (const [key, val] of Object.entries(data)) {
        if (val.status === "waiting") waiting.push({ key, ...val });
        else if (val.status === "calling") calling.push({ key, ...val });
      }
      renderList(waitingList, waiting, "waiting");
      renderList(callingList, calling, "calling");
    });

    function renderList(container, list, type) {
      container.innerHTML = "";
      if (list.length === 0) {
        container.innerHTML = "<p>なし</p>";
        return;
      }
      list.sort((a, b) => a.number - b.number);
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "ticket";
        div.textContent = item.number;
        div.addEventListener("click", async () => {
          if (type === "waiting") {
            if (confirm(`${item.number}番を呼び出しますか？`)) {
              await update(ref(db, `tickets/${item.key}`), { status: "calling" });
            }
          } else if (type === "calling") {
            if (confirm(`${item.number}番の商品を受け渡しましたか？`)) {
              await remove(ref(db, `tickets/${item.key}`));

              // 呼び出し済み一覧に追加表示
              const div = document.createElement("div");
              div.className = "ticket";
              div.textContent = item.number;
              completedList.prepend(div); // 最新を上に
            }
          }
        });
        container.appendChild(div);
      });
    }



    // clearAllBtn.addEventListener("click", async () => {
    //   if (confirm("全チケットを削除しますか？")) {
    //     await remove(ticketsRef);
    //   }
    // });
  </script>
</head>

<body>
  <h1> マジカルチュロリポップ <br> 管理ページ </h1>
  <p>１．待機中の呼び出し番号をタップ<br>
    ２．商品受け渡し後、呼び出し中番号をタップ
  </p>

  <div class="lists-container">
    <div class="list-box">
      <h2>📣 呼び出し中</h2>
      <div id="callingList"></div>
    </div>

    <div class="list-box">
      <h2>⏳ 待機中</h2>
      <div id="waitingList"></div>
    </div>
  </div>

  <div class="completed-wrapper">
    <div class="completed-box">
      <h2>✅ 呼び出し済み</h2>
      <div id="completedList"></div>
    </div>
  </div>

  <!-- <button id="clearAll">すべて削除 🧹</button> -->
</body>

</html>